---
title: "Descriptive Statistic Plots - HPS"
format: pdf
editor: visual
---

# Load Packages

```{r}
#| label: load_packages
#| message: false

library(tidyverse)
library(ggplot2)
library(forcats)
```

# Load Cleaned Dataset

```{r}
#| label: load_cleaned_data

load("/home2/wburr/Shawn_Research/data/HPS.rda")
```

# Plotting Descriptive Statistics (Location, Age, and Gender)

## Pick-Up Location / Sending Facility

```{r}
#| label: plot_pickup_location

# Plot the percentage of calls from each pick-up location
HPS_pickup_plot <- ggplot(HPS,
                          aes(x = fct_infreq(PickupLocationDescription),
                              y = (after_stat(count)) / sum(after_stat(count)))) +
                   geom_bar() +
                   geom_text(aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) , 3) * 100, "%")),
                            stat = "count",
                            vjust = -0.1,
                            size = 3.5) +
                   scale_y_continuous(labels = scales::percent_format(),
                                      breaks = seq(0, 0.65, 0.1))+
                   scale_x_discrete(labels = c("House/Town House" = "House/ \nTown House",
                                               "Hospital (Acute & Non-Acute)" = "Hospital (Acute \n& Non-Acute)",
                                               "Apartment/Condo. Building" = "Apartment/ \nCondo. Building",
                                               "Street/Highway/Road" = "Street/Highway/ \nRoad",
                                               "Long-Term Care Home" = "Long-Term \nCare Home",
                                               "Other (Describe in Remarks)" = "Other (Describe \nin Remarks)"))+
                   labs(title = "HPS Drug Toxicity Calls - Pick-Up Location/Sending Facility",
                       y = "Percent of Calls",
                       x = "Pick-Up Location/Sending Facility")

# Save the plot as a .png in a separate folder
ggsave(file = "/home2/wburr/Shawn_Research/scripts/2_descriptive_stats_and_plots/2_descriptive_statistic_plots_HPS/HPS_pickup_plot.png",
       width = 8,
       height = 5)

# Print the plot                   
HPS_pickup_plot
```

## Destination / Recieving Facility

```{r}
#| label: plot_destination

# Plot the percentage of calls from each pick-up location
HPS_destination_plot <- ggplot(HPS,
                          aes(x = fct_infreq(`Receiving Facility/Destination`),
                              y = after_stat(count) / sum(after_stat(count)))) +
                   geom_bar() +
                   geom_text(aes(label = paste0(round(after_stat(count)/sum(after_stat(count)) , 3) * 100, "%")),
                            stat = "count",
                            vjust = -0.1,
                            size = 3.5) +
                   scale_y_continuous(labels = scales::percent_format(),
                                      breaks = seq(0, 0.45, 0.1)) +
                   scale_x_discrete(labels = label_wrap_gen(16))+
                   labs(title = "HPS Drug Toxicity Calls - Destination/Recieving Facility",
                       y = "Percent of Calls",
                       x = "Destination/Recieving Facility")

# Save the plot as a .png in a separate folder
ggsave(file = "/home2/wburr/Shawn_Research/scripts/2_descriptive_stats_and_plots/2_descriptive_statistic_plots_HPS/HPS_destination_plot.png",
       width = 8,
       height = 5)

# Print the plot                   
HPS_destination_plot
```

## Age

```{r}
#| label: plot_age 
#| message: false

# Plot a histogram of the distribution of patient ages 
HPS_age_plot <- ggplot(HPS,
                       aes(x = Age)) +
                geom_histogram(binwidth = 5,
                               aes(y = after_stat(count) / sum(after_stat(count)))) +
                scale_y_continuous(labels = scales::percent_format(),
                                   limits = c(0, 0.15)) +
                scale_x_continuous(breaks = seq(0, 100, by = 10)) +
                scale_x_continuous(breaks = seq(0, 100, by= 10)) +
                labs(title = "HPS Drug Toxicity Calls - Age Distribution",
                     y = "Percentage of Calls")

# Save the plot as a .png in a separate folder
ggsave(file = "/home2/wburr/Shawn_Research/scripts/2_descriptive_stats_and_plots/2_descriptive_statistic_plots_HPS/HPS_age_plot.png",
       width = 8,
       height = 5)

# Print the plot
HPS_age_plot
```

## Gender

```{r}
#| label: plot_gender

# Plot a bar graph to show patient  gender demographics
HPS_gender_plot <- ggplot(HPS,
                          aes(x = Gender)) + 
                   geom_bar(aes(y = after_stat(count) / sum(after_stat(count)))) +
                   geom_text(aes(y = after_stat(count) / sum(after_stat(count)), 
                                 label = paste0(round(after_stat(count) / sum(after_stat(count)) , 3) * 100, "%")),
                                 stat = "count",
                                 vjust = -0.1) +
                   scale_y_continuous(labels = scales::percent_format(),
                                      breaks = seq(0, 0.6, 0.1)) +
                   scale_x_discrete(label = c("Female", "Male")) +
                   labs(title = "HPS Drug Toxicity Calls - Gender",
                        y = "Percentage of Calls",
                        x = "Gender")

# Save the plot as a .png in a separate folder
ggsave(file = "/home2/wburr/Shawn_Research/scripts/2_descriptive_stats_and_plots/2_descriptive_statistic_plots_HPS/HPS_gender_plot.png",
       width = 8,
       height = 5)

# Print the plot
HPS_gender_plot
```

## Age and Gender

```{r}
#| label: plot_age_gender

# Plot a boxplot to show the age and gender demographics of patients 
HPS_age_gender_plot <- ggplot(HPS,
                              aes(x = Gender,
                                  y = Age)) +
                       geom_boxplot() +
                       scale_y_continuous(breaks = seq(0, 100, by = 10)) +
                       scale_x_discrete(labels = c("Female", "Male")) +
                       labs(title = "HPS Drug Toxicity Calls - Age and Gender")

# Save the plot as a .png in a separate folder
ggsave(file = "/home2/wburr/Shawn_Research/scripts/2_descriptive_stats_and_plots/2_descriptive_statistic_plots_HPS/HPS_age_gender_plot.png",
       width = 7,
       height = 5)

# Print the plot
HPS_age_gender_plot
```

# Standardize Timeline Data by Population

```{r}
#| label: standardize_data

# Summarize call counts per year
HPS_call_counts_yearly <- HPS |>
                          count(Call_Year) |>
                                   # Set the years 2016 to 2025 as factors
                          complete(Call_Year = factor(2016:2025), 
                                   # Fill all empty values with 0
                                   fill = list(n = 0)) |>
                          # Express the yearly call counts as a crude rate per 1000 population
                          # Crude Rate (per 1000 population) = (Call Counts / Population) * 1000
                          mutate(standardized_per_1000 = (n / nrow(HPS)) * 1000)

# Summarize call counts per month
HPS_call_counts_monthly <- HPS |>
                           count(Call_Year, Call_Month) |>
                           complete(Call_Year = factor(2016:2025),
                                    Call_Month = factor(1:12),
                                    fill = list(n = 0)) |>
                          # Express the yearly call counts as a crude rate per 1000 population
                          # Crude Rate (per 1000 population) = (Call Counts / Population) * 1000
                           mutate(standardized_per_1000 = (n / nrow(HPS)) * 1000)
```

# Plotting Descriptive Statistics (Yearly and Monthly Call Counts)

## Calls per Year

```{r}
#| labels: plot_calls_per_year

# Plot the number of calls per year on a bar plot
HPS_call_per_year_barplot <- ggplot(HPS_call_counts_yearly,
                                    aes(x = Call_Year,
                                        y = n)) +
                             geom_bar(stat = "identity") +
                             geom_text(aes(label = n),
                                       vjust = -0.1,
                                       size = 3.5) +
                             labs(title = "Number of HPS Drug Toxicity Calls per Year",
                                  x = "Year",
                                  y = "Number of Calls")

# Print the bar plot
HPS_call_per_year_barplot

# Save the plot as a .png in a separate folder
ggsave(file = "/home2/wburr/Shawn_Research/scripts/2_descriptive_stats_and_plots/2_descriptive_statistic_plots_HPS/HPS_calls_peryear_barplot.png",
       width = 9,
       height = 5)

# Plot the number of calls per year on a line plot
HPS_call_per_year_lineplot <- ggplot(HPS_call_counts_yearly,
                                    aes(x = Call_Year,
                                        y = n,
                                        group = 1)) +
                             geom_line() +
                             geom_point() +
                             labs(title = "Number of HPS Drug Toxicity Calls per Year",
                                  x = "Year",
                                  y = "Number of Calls")
                          
# Print the line plot
HPS_call_per_year_lineplot

# Save the plot as a .png in a separate folder
ggsave(file = "/home2/wburr/Shawn_Research/scripts/2_descriptive_stats_and_plots/2_descriptive_statistic_plots_HPS/HPS_calls_peryear_lineplot.png",
       width = 9,
       height = 5)
```

## Calls per Month

```{r}
#| labels: plot_calls_per_month

# Plot the number of calls per month (subsetted by year) on a bar plot
HPS_call_per_month_barplot <- ggplot(HPS_call_counts_monthly,
                                  aes(x = Call_Month,
                                      y = n)) +
                           geom_bar(stat = "identity") +
                           facet_wrap(Call_Year~.,
                                      ncol = 5) +
                           labs(title = "Number of HPS Drug Toxicity Calls per Month",
                                x = "Month",
                                y = "Number of Calls")

# Print the bar plot
HPS_call_per_month_barplot

# Save the plot as a .png in a separate folder
ggsave(file = "/home2/wburr/Shawn_Research/scripts/2_descriptive_stats_and_plots/2_descriptive_statistic_plots_HPS/HPS_calls_permonth_barplot.png",
       width = 9,
       height = 5)

# Plot the number of calls per month (subsetted by year) on a line plot
HPS_call_per_month_lineplot <- ggplot(HPS_call_counts_monthly,
                                      aes(x = Call_Month,
                                          y = n,
                                          group = Call_Year,
                                          color = Call_Year)) +
                               geom_line() +
                               geom_point() +
                               labs(title = "Number of HPS Drug Toxicity Calls per Month",
                                    x = "Month",
                                    y = "Number of Calls")
                               

# Print the bar plot
HPS_call_per_month_lineplot # This plot is hard to read so will not be used

# Save the plot as a .png in a separate folder
ggsave(file = "/home2/wburr/Shawn_Research/scripts/2_descriptive_stats_and_plots/2_descriptive_statistic_plots_HPS/HPS_calls_permonth_lineplot.png",
       width = 9,
       height = 5)
```

## Calls per Year - Standardized

```{r}
#| labels: plot_calls_per_year_standardized

# Plot the number of calls per year on a bar plot
HPS_call_per_year_crude_plot <- ggplot(HPS_call_counts_yearly,
                                    aes(x = Call_Year,
                                        y = standardized_per_1000,
                                        group = 1)) +
                             geom_line() +
                             geom_point() +
                             labs(title = "Crude Rate of HPS Drug Toxicity Calls per Year",
                                  x = "Year",
                                  y = "Number of Calls - Crude Rate (per 1000 Population)")

# Print the bar plot
HPS_call_per_year_crude_plot

# Save the plot as a .png in a separate folder
ggsave(file = "/home2/wburr/Shawn_Research/scripts/2_descriptive_stats_and_plots/2_descriptive_statistic_plots_HPS/HPS_calls_peryear_standardized_plot.png",
       width = 9,
       height = 5)
```

## Calls per Month - Standardized

```{r}
#| labels: plot_calls_per_month_standardized

# Plot the number of calls per year on a bar plot
HPS_call_per_month_crude_plot <- ggplot(HPS_call_counts_monthly,
                                    aes(x = Call_Month,
                                        y = standardized_per_1000,
                                        group = 1)) +
                             geom_line() +
                             facet_wrap(Call_Year~.,
                                        ncol = 5) +
                             labs(title = "Crude Rate of HPS Drug Toxicity Calls per Month",
                                  x = "Month",
                                  y = "Number of Calls - Crude Rate (per 1000 Population)")

# Print the bar plot
HPS_call_per_month_crude_plot

# Save the plot as a .png in a separate folder
ggsave(file = "/home2/wburr/Shawn_Research/scripts/2_descriptive_stats_and_plots/2_descriptive_statistic_plots_HPS/HPS_calls_permonth_standardized_plot.png",
       width = 9,
       height = 5)
```
